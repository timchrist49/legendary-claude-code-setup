#!/usr/bin/env bash
# claude-permissions-review - Review and add suggested permissions
# Interactive tool to batch-approve permission suggestions

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Files
SUGGESTIONS_LOG="$HOME/.claude/permission-suggestions.log"
SETTINGS_FILE="$HOME/.claude/settings.local.json"
AUTO_APPROVE="${AUTO_APPROVE:-0}"

# ============================================================================
# Usage
# ============================================================================
usage() {
    cat << EOF
${CYAN}claude-permissions-review${NC} - Review and add suggested permissions

${YELLOW}Usage:${NC}
    claude-permissions-review [options]

${YELLOW}Options:${NC}
    --auto          Auto-approve all suggestions without prompts
    --help          Show this help message

${YELLOW}Examples:${NC}
    claude-permissions-review          # Interactive review
    claude-permissions-review --auto   # Auto-approve all

${YELLOW}What it does:${NC}
    - Reads suggestions from ~/.claude/permission-suggestions.log
    - Groups unique permission suggestions
    - Shows each suggestion with context
    - Asks to approve each (or all with --auto)
    - Adds approved permissions to settings.local.json
    - Clears the log after successful additions

EOF
    exit 0
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --auto)
            AUTO_APPROVE=1
            shift
            ;;
        --help|-h)
            usage
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}" >&2
            echo "Run --help for usage" >&2
            exit 1
            ;;
    esac
done

# ============================================================================
# Check for suggestions
# ============================================================================
if [[ ! -f "$SUGGESTIONS_LOG" ]]; then
    echo -e "${YELLOW}No permission suggestions found.${NC}"
    echo "Suggestions will be logged automatically as you use Claude Code."
    exit 0
fi

# Read and group suggestions
declare -A PERMISSION_COUNT
declare -A PERMISSION_CONTEXT

while IFS= read -r line; do
    perm=$(echo "$line" | jq -r '.permission // empty' 2>/dev/null)
    ctx=$(echo "$line" | jq -r '.context // "unknown"' 2>/dev/null)

    if [[ -n "$perm" ]]; then
        PERMISSION_COUNT[$perm]=$((${PERMISSION_COUNT[$perm]:-0} + 1))
        PERMISSION_CONTEXT[$perm]="$ctx"
    fi
done < "$SUGGESTIONS_LOG"

if [[ ${#PERMISSION_COUNT[@]} -eq 0 ]]; then
    echo -e "${YELLOW}No valid permission suggestions found.${NC}"
    rm -f "$SUGGESTIONS_LOG"
    exit 0
fi

# ============================================================================
# Display suggestions
# ============================================================================
echo -e "${CYAN}Found ${#PERMISSION_COUNT[@]} unique permission suggestions:${NC}"
echo ""

index=0
to_add=()

for perm in "${!PERMISSION_COUNT[@]}"; do
    index=$((index + 1))
    count="${PERMISSION_COUNT[$perm]}"
    ctx="${PERMISSION_CONTEXT[$perm]}"

    echo -e "${CYAN}$index.${NC} ${GREEN}$perm${NC}"
    echo -e "   Context: $ctx"
    echo -e "   Times suggested: $count"
    echo ""

    if [[ "$AUTO_APPROVE" -eq 1 ]]; then
        to_add+=("$perm")
    else
        read -r -p "Add this permission? [y/n/all/quit]: " response
        case "$response" in
            [Yy]*)
                to_add+=("$perm")
                ;;
            [Aa]*)
                to_add+=("$perm")
                AUTO_APPROVE=1
                ;;
            [Qq]*)
                echo "Exiting. No changes made."
                exit 0
                ;;
            *)
                # Skip
                ;;
        esac
    fi
done

# ============================================================================
# Add permissions to settings
# ============================================================================
if [[ ${#to_add[@]} -eq 0 ]]; then
    echo -e "${YELLOW}No permissions selected. Exiting.${NC}"
    exit 0
fi

echo ""
echo -e "${GREEN}Adding ${#to_add[@]} permissions to $SETTINGS_FILE${NC}"

# Backup existing file
if [[ -f "$SETTINGS_FILE" ]]; then
    cp "$SETTINGS_FILE" "${SETTINGS_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
fi

# Read existing permissions
existing_perms=$(jq -r '.permissions.allow[] // empty' "$SETTINGS_FILE" 2>/dev/null || echo "")

# Build new permissions array
for perm in "${to_add[@]}"; do
    if ! echo "$existing_perms" | grep -qF "$perm"; then
        existing_perms="${existing_perms}${existing_perms+$'\n'}$perm"
    fi
done

# Generate new JSON
new_json=$(echo "$existing_perms" | jq -R . | jq -s '. | {permissions: {allow: .}}')

# Write to file
echo "$new_json" > "$SETTINGS_FILE"

# Clear suggestions log
rm -f "$SUGGESTIONS_LOG"

echo -e "${GREEN}✓ Permissions added successfully${NC}"
echo -e "${GREEN}✓ Suggestions log cleared${NC}"
echo ""
echo -e "${CYAN}Next:${NC} Restart Claude Code for changes to take effect"
